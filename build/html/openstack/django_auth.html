

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13. Django认证：horizon登录认证解析 &mdash; Welcome to Sitian&#39;s Blog 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Welcome to Sitian&#39;s Blog 1.0 documentation" href="../index.html"/>
        <link rel="up" title="OpenStack Note" href="index.html"/>
        <link rel="next" title="14. 云平台服务器重启注意事项" href="cloud_check.html"/>
        <link rel="prev" title="12. django通用视图：一个小问题引发的思考" href="django-generic_view.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Welcome to Sitian's Blog
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../py_doc/index.html">Python Note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux_tools/index.html">Hack Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">OpenStack Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="horizon_develop.html">1. Horizon 二次开发指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="image-create-guide.html">2. OpenStack镜像制作</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_synopsis.html">3. OpenStack 部署实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="centos_vm_netconf.html">4. Centos虚拟机联网配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="lanch_instance_failure.html">5. OpenStack 启动虚拟机失败分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="rabbitmq_doc.html">6. [翻译] rabbitmq教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="os_cmd.html">7. openstack命令汇总</a></li>
<li class="toctree-l2"><a class="reference internal" href="kvm_error.html">8. KVM错误问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="django_middleware.html">9. django中间件和openstack用户重登录分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="horizon_workflows_analysis.html">10. [翻译] horizon workflows分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="horizon_launch_instance.html">11. horizon启动虚拟机分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="django-generic_view.html">12. django通用视图：一个小问题引发的思考</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">13. Django认证：horizon登录认证解析</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#url">13.1. url映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">13.2. 用户登录认证</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">13.2.1. 表单处理程序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">13.2.2. 表单处理URL映射过程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">13.2.3. 表单处理程序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#django">13.2.4. django认证后端</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">13.3. 参考</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cloud_check.html">14. 云平台服务器重启注意事项</a></li>
<li class="toctree-l2"><a class="reference internal" href="paste_webob_routes.html">15. OpenStack REST-API基础：paste/webob/routes库</a></li>
<li class="toctree-l2"><a class="reference internal" href="opengrok_xp.html">16. OpenGrok代码浏览环境搭建</a></li>
<li class="toctree-l2"><a class="reference internal" href="nova_api.html">17. nova-api分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="nova_smd.html">18. [翻译] nova：Services、Managers and Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="oslo_cfg.html">19. oslo.config 用法总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="kombu.html">20. kombu和消息队列总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="openstack_debug.html">21. OpenStack 调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="nova_rpcserver_start.html">22. nova rpc服务启动分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="periodic_task.html">23. OpenStack周期性任务分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="nova_log.html">24. OpenStack 日志模块分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemu_kvm.html">25. qemu/kvm学习笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="virt_cmd.html">26. 虚拟化相关命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemu_img_encry.html">27. nova虚机加密总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="nova_interact.html">28. nova组件间交互总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="juno_neutron-meter-agent_install.html">29. juno安装neutron-meter-agent</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">网络技术/neutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../others/index.html">未分类</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Welcome to Sitian's Blog</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">OpenStack Note</a> &raquo;</li>
      
    <li>13. Django认证：horizon登录认证解析</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/openstack/django_auth.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="django-horizon">
<span id="django-auth"></span><h1><a class="toc-backref" href="#id26">13. Django认证：horizon登录认证解析</a><a class="headerlink" href="#django-horizon" title="Permalink to this headline">¶</a></h1>
<p><strong>date: 2017-04-25 17:11</strong></p>
<div class="contents topic" id="id1">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><a class="reference internal" href="#django-horizon" id="id26">Django认证：horizon登录认证解析</a><ul>
<li><a class="reference internal" href="#url" id="id27">url映射</a></li>
<li><a class="reference internal" href="#id2" id="id28">用户登录认证</a><ul>
<li><a class="reference internal" href="#id3" id="id29">表单处理程序</a></li>
<li><a class="reference internal" href="#id5" id="id30">表单处理URL映射过程</a></li>
<li><a class="reference internal" href="#id6" id="id31">表单处理程序</a></li>
<li><a class="reference internal" href="#django" id="id32">django认证后端</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7" id="id33">参考</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<p>在我之前的文章《django中间件和用户重登陆分析》中，分析了Django中间件并简要分析分析了openstack horizon用户登录流程，
最近深究这个模块时，发现这里面也大有学问，涉及到的知识点也很多，自己对horizon登录认证这一部分，
也分析了好久，才算有一个比较深刻的认识，而之前写的那篇文章，有很大的知识点错误，现在另起一篇博文，进行分析。</p>
<p>下面对用户登录horizon的流程和Django认证backend流程记录下来，并会简要分析django认证框架相关实现代码。
由于主要关注的是Django认证过程，相关无关部分会忽略掉。</p>
<div class="section" id="url">
<h2><a class="toc-backref" href="#id27">13.1. url映射</a><a class="headerlink" href="#url" title="Permalink to this headline">¶</a></h2>
<p>用户输入IP地址，根据setting.py ROOT_URLCONF配置项来决定根URL映射函数；</p>
<div class="figure align-center" id="id13">
<a class="reference internal image-reference" href="../_images/root_urlconf.png"><img alt="../_images/root_urlconf.png" src="../_images/root_urlconf.png" style="width: 668.0px; height: 73.0px;" /></a>
<p class="caption"><span class="caption-text">openstack_dashboard/setting.py ROOT_URLCONF 配置项</span></p>
</div>
<p>然后，根据URL匹配调用view处理函数(splash函数。)</p>
<div class="figure align-center" id="id14">
<a class="reference internal image-reference" href="../_images/url_map.png"><img alt="../_images/url_map.png" src="../_images/url_map.png" style="width: 791.0px; height: 169.0px;" /></a>
<p class="caption"><span class="caption-text">openstack_dashboard/urls.py</span></p>
</div>
<p>注意：ROOT_URLCONF配置项很重要，整个URL只能匹配该urls.py所指定的。
假如我们输入一个正则无法匹配的，就会提示如下错误：</p>
<div class="figure align-center" id="id15">
<a class="reference internal image-reference" href="../_images/page_not_found.png"><img alt="../_images/page_not_found.png" src="../_images/page_not_found.png" style="width: 792.0px; height: 613.0px;" /></a>
<p class="caption"><span class="caption-text">url模式</span></p>
</div>
<p>根据上图中所列出的URL模式，可以看到所有可匹配URL都是由root urls.py文件决定。
需要注意的是urls.py中的include模式。</p>
<p>然后根据request session判断用户是否认证(请求中间件拦截，判断是否会话失效，这里不予考虑)，
如果认证，则重定向到用户主界面；否则就加载模板系统，显示登录主界面；</p>
<div class="figure align-center" id="id16">
<a class="reference internal image-reference" href="../_images/splash.png"><img alt="../_images/splash.png" src="../_images/splash.png" style="width: 782.0px; height: 344.0px;" /></a>
<p class="caption"><span class="caption-text">openstack_dashboard/views.py</span></p>
</div>
<div class="figure align-center" id="id17">
<a class="reference internal image-reference" href="../_images/splash_html.png"><img alt="../_images/splash_html.png" src="../_images/splash_html.png" style="width: 730.0px; height: 293.0px;" /></a>
<p class="caption"><span class="caption-text">horizon/templates/splash.html 模板include表单模板</span></p>
</div>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id28">13.2. 用户登录认证</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">原来自己写的表单校验与用户认证流程有重大错误。整个认证流程，自己通过不断的打日志和代码分析，
已经完全理解清晰。下面对整个过程进行更新！</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id29">13.2.1. 表单处理程序</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>显示登录主界面后，用户输入信息，提交表单，根据表单action属性匹配映射处理函数。</p>
<div class="figure align-center" id="id18">
<a class="reference internal image-reference" href="../_images/form_action.png"><img alt="../_images/form_action.png" src="../_images/form_action.png" style="width: 1107.0px; height: 234.0px;" /></a>
<p class="caption"><span class="caption-text">登录页面，表单action属性。</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>_login.html 表单继承 model_from1.html，并重写action 属性，但是{% url &#8216;login&#8217; %} 最后怎么转换成&#8221;auth/login&#8221;，
还需要进一步的分析。</p>
<div class="figure align-center" id="id19">
<a class="reference internal image-reference" href="../_images/model_form1.png"><img alt="../_images/model_form1.png" src="../_images/model_form1.png" style="width: 597.0px; height: 131.0px;" /></a>
<p class="caption"><span class="caption-text">基类表单模板action属性</span></p>
</div>
<div class="last figure align-center" id="id20">
<a class="reference internal image-reference" href="../_images/model_form1.png"><img alt="../_images/model_form1.png" src="../_images/model_form1.png" style="width: 597.0px; height: 131.0px;" /></a>
<p class="caption"><span class="caption-text">_login.html 模板表单重写action 属性</span></p>
</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上面提到的{% url &#8216;login&#8217; %}最后怎么转换成&#8221;auth/login&#8221;的过程已经理清，这里涉及到django中的name参数。</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># openstack_auth/urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span>
    <span class="s1">&#39;openstack_auth.views&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^testlogin/$&quot;</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dlogin&#39;</span><span class="p">),</span>
</pre></div>
</div>
<div class="figure align-center" id="id21">
<a class="reference internal image-reference" href="../_images/testlogin.png"><img alt="../_images/testlogin.png" src="../_images/testlogin.png" style="width: 851.0px; height: 197.0px;" /></a>
<p class="caption"><span class="caption-text">页面显示代码</span></p>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># 魔板文件重写form_action属性！</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">form_action</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">url</span> <span class="s1">&#39;dlogin&#39;</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>页面模板使用{%url &#8216;dlogin&#8217; %}转换url，所以总是转换成该名字对应的URL。</p>
<table class="last docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>论述了django URL name参数的用法及其意义。<a class="reference external" href="http://www.cnblogs.com/no13bus/p/3767521.html">http://www.cnblogs.com/no13bus/p/3767521.html</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id30">13.2.2. 表单处理URL映射过程</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>表单映射过程的URL截断，分级URL匹配。</p>
<div class="figure align-center" id="id22">
<a class="reference internal image-reference" href="../_images/url_include_1.png"><img alt="../_images/url_include_1.png" src="../_images/url_include_1.png" style="width: 768.0px; height: 197.0px;" /></a>
<p class="caption"><span class="caption-text">URL include 截断匹配</span></p>
</div>
<div class="figure align-center" id="id23">
<a class="reference internal image-reference" href="../_images/auth_url.png"><img alt="../_images/auth_url.png" src="../_images/auth_url.png" style="width: 630.0px; height: 193.0px;" /></a>
<p class="caption"><span class="caption-text">URL分级匹配</span></p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>每当Django遇到 include() 时，它将截断匹配的URL，并把剩余的字符串发往包含的URLconf作进一步处理。</p>
<p class="last">include 通常用于网站目录分类处理，使项目中urls高度统一。</p>
</div>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id31">13.2.3. 表单处理程序</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>这里为了便于分析，我把整个登录提交表单对应的处理代码贴出来。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">file:</th><td class="field-body"><cite>openstack_auth/views.py:login</cite></td>
</tr>
</tbody>
</table>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@sensitive_post_parameters</span><span class="p">()</span>
<span class="nd">@csrf_protect</span>
<span class="nd">@never_cache</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra_context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logs a user in using the :class:`~openstack_auth.forms.Login` form.&quot;&quot;&quot;</span>
    <span class="c1"># If the user is already authenticated, redirect them to the</span>
    <span class="c1"># dashboard straight away, unless the &#39;next&#39; parameter is set as it</span>
    <span class="c1"># usually indicates requesting access to a page that requires different</span>
    <span class="c1"># permissions.</span>
    <span class="c1">#LOG_DEBUG(info=locals())</span>
    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">and</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">REDIRECT_FIELD_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span> <span class="ow">and</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">REDIRECT_FIELD_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shortcuts</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_REDIRECT_URL</span><span class="p">)</span>

    <span class="c1"># Get our initial region for the form.</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_region</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;region_endpoint&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">requested_region</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;AVAILABLE_REGIONS&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">requested_region</span> <span class="ow">in</span> <span class="n">regions</span> <span class="ow">and</span> <span class="n">requested_region</span> <span class="o">!=</span> <span class="n">current_region</span><span class="p">:</span>
        <span class="n">initial</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">requested_region</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># NOTE(saschpe): Since https://code.djangoproject.com/ticket/15198,</span>
        <span class="c1"># the &#39;request&#39; object is passed directly to AuthenticationForm in</span>
        <span class="c1"># django.contrib.auth.views#login:</span>
        <span class="k">if</span> <span class="n">django</span><span class="o">.</span><span class="n">VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">curry</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Login</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">curry</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Login</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">curry</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Login</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extra_context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">extra_context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;redirect_field_name&#39;</span><span class="p">:</span> <span class="n">auth</span><span class="o">.</span><span class="n">REDIRECT_FIELD_NAME</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">template_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;auth/_login.html&#39;</span>
            <span class="n">extra_context</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;auth/login.html&#39;</span>

    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">user_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="n">template_name</span><span class="p">,</span>
              <span class="n">authentication_form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
              <span class="n">extra_context</span><span class="o">=</span><span class="n">extra_context</span><span class="p">,</span>
              <span class="n">kw</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">django_auth_views</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                  <span class="n">template_name</span><span class="o">=</span><span class="n">template_name</span><span class="p">,</span>
                                  <span class="n">authentication_form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                                  <span class="n">extra_context</span><span class="o">=</span><span class="n">extra_context</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Set the session data here because django&#39;s session key rotation</span>
    <span class="c1"># will erase it if we set it earlier.</span>
    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">user_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">auth_user</span><span class="o">.</span><span class="n">set_session_from_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Login</span><span class="o">.</span><span class="n">get_region_choices</span><span class="p">())</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">endpoint</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="n">regions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;region_endpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;region_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_name</span>
    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</td></tr></table></div>
<p>这里的关键是第51行代码 <code class="docutils literal"><span class="pre">res</span> <span class="pre">=</span> <span class="pre">django_auth_views.login(request,</span></code> ，
调用这个函数时，会把登录表单类实例作为参数。然后在 <code class="xref py py-func docutils literal"><span class="pre">django.contrib.auth.login()</span></code> 函数里面，
会调用 <code class="docutils literal"><span class="pre">openstack_auth.forms.Login:clean()</span></code> 方法，请看clean方法的调用堆栈：</p>
<div class="figure align-center" id="id24">
<a class="reference internal image-reference" href="../_images/clean_call_stack.png"><img alt="../_images/clean_call_stack.png" src="../_images/clean_call_stack.png" style="width: 1440.0px; height: 497.0px;" /></a>
<p class="caption"><span class="caption-text">登录表单forms的clean()方法调用堆栈</span></p>
</div>
<p><strong>登录表单重写的clean方法一方面会执行数据校验，然后会根据输入的用户名和密码，
进行用户认证(会调用keystone认证后端，后面会详细描述)。</strong></p>
<p><code class="file docutils literal"><span class="pre">openstack_auth/forms:Login.clean</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@sensitive_variables</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="s1">&#39;add clean here?&#39;</span><span class="p">)</span>
    <span class="n">LOG_STACK</span><span class="p">()</span>
    <span class="n">default_domain</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
                             <span class="s1">&#39;OPENSTACK_KEYSTONE_DEFAULT_DOMAIN&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Default&#39;</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;region&#39;</span><span class="p">)</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="n">default_domain</span><span class="p">)</span>

    <span class="c1">#get usbkey sn add by wuzhifan@cecgw.cn at 2014-6-19</span>
    <span class="n">usbkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usbkey&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">):</span>
        <span class="c1"># Don&#39;t authenticate, just let the other validators handle it.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span>
    <span class="c1">### add by zhaoyuanjie</span>
    <span class="n">client_ip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class="p">):</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>

    <span class="c1"># cec: get login failed times</span>
    <span class="n">login_cnt</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CECUserLoginCnt</span><span class="o">.</span><span class="n">get_login_cnt</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">)</span>

    <span class="c1"># cec:</span>
    <span class="k">if</span> <span class="n">login_cnt</span> <span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;User login failed more than 3 times, please try again later!&#39;</span><span class="p">))</span>
    <span class="c1"># add by zhaoyuanjie</span>
    <span class="c1"># add by wangxing@cecgw.cn for time access control to users</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Is true or false: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">Acl_user</span><span class="o">.</span><span class="n">in_user_access_timerange</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Acl_user</span><span class="o">.</span><span class="n">in_user_access_timerange</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The user&#39;s current time cannot access system!&quot;</span><span class="p">))</span>
    <span class="c1"># add end</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                   <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                   <span class="n">user_domain_name</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                   <span class="n">auth_url</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                   <span class="n">usbkey</span><span class="o">=</span><span class="n">usbkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_cache</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                                       <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                       <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                                       <span class="n">user_domain_name</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                                       <span class="n">auth_url</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                       <span class="n">usbkey</span><span class="o">=</span><span class="n">usbkey</span><span class="p">)</span>  <span class="c1">#add by wuzhifan@cecgw.cn at 2014.11.15</span>
        <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">user_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_cache</span><span class="p">,</span> <span class="n">user_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_cache</span><span class="p">))</span>
        <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_cache</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Login successful for user &quot;</span><span class="si">%(username)s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> \
            <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="n">log_common</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">log_common</span><span class="o">.</span><span class="n">LOG_TYPE</span> <span class="o">+</span> <span class="s2">u&quot; [用户:</span><span class="si">%s</span><span class="s2">] 登陆IP:</span><span class="si">%s</span><span class="s2"> [登陆系统] </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">log_common</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_cache</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
        <span class="n">ceclog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeystoneAuthException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Login failed for user &quot;</span><span class="si">%(username)s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> \
            <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="n">log_common</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">log_common</span><span class="o">.</span><span class="n">LOG_TYPE</span> <span class="o">+</span> <span class="s2">u&quot; [用户:</span><span class="si">%s</span><span class="s2">] 登陆IP:</span><span class="si">%s</span><span class="s2"> [登陆系统] </span><span class="si">%s</span><span class="s2">&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">log_common</span><span class="o">.</span><span class="n">STATUS_FAIL</span><span class="p">)</span>
        <span class="n">ceclog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># cec: update login failed times</span>
        <span class="n">models</span><span class="o">.</span><span class="n">CECUserLoginCnt</span><span class="o">.</span><span class="n">update_login_cnt</span><span class="p">(</span><span class="n">username</span><span class="p">,</span>
               <span class="n">client_ip</span><span class="p">,</span> <span class="n">login_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># add by zhaoyuanjie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;check_for_test_cookie&#39;</span><span class="p">):</span>  <span class="c1"># Dropped in django 1.7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_test_cookie</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>表单数据检验，注意可以使用clean_message方法来校验每一个表单属性，也可以使用clean 方法整体校验。</li>
<li>表单校验clean函数，需要返回原始数据(cleaned_data)，否则会发生数据丢失。</li>
</ul>
</div>
</div>
<div class="section" id="django">
<h3><a class="toc-backref" href="#id32">13.2.4. django认证后端</a><a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h3>
<p>登录表单forms的clean方法，在第45行 <code class="docutils literal"><span class="pre">self.user_cache</span> <span class="pre">=</span> <span class="pre">authenticate(request=self.request,</span></code> 这一处代码中，
会执行用户认证。查看 <code class="xref py py-func docutils literal"><span class="pre">authenticate()</span></code> 函数代码，实际上该函数会调用settings.py配置的认证后端：</p>
<div class="figure align-center" id="id25">
<a class="reference internal image-reference" href="../_images/auth_backend.png"><img alt="../_images/auth_backend.png" src="../_images/auth_backend.png" style="width: 816.0px; height: 119.0px;" /></a>
<p class="caption"><span class="caption-text">setting.py认证后端项</span></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">file:</th><td class="field-body"><cite>django.contrib.auth.__init__</cite></td>
</tr>
</tbody>
</table>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_backends</span><span class="p">():</span>
    <span class="n">backends</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">backend_path</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTHENTICATION_BACKENDS</span><span class="p">:</span>
        <span class="n">backends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_backend</span><span class="p">(</span><span class="n">backend_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">backends</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                   <span class="s1">&#39;No authentication backends have been defined. Does AUTHENTICATION_BACKENDS contain anything?&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">backends</span>

<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the given credentials are valid, return a User object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">get_backends</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># This backend doesn&#39;t accept these credentials as arguments. Try the next one.</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="n">PermissionDenied</span><span class="p">:</span>
            <span class="c1"># This backend says to stop in our tracks - this user should not be allowed in at all.</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Annotate the user object with the path of the backend.</span>
        <span class="n">user</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="c1"># The credentials supplied are invalid to all backends, fire signal</span>
    <span class="n">user_login_failed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">__name__</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">_clean_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>从 <code class="xref py py-func docutils literal"><span class="pre">authenticate()</span></code> 函数的实现来看，Django可以配置多个认证后端。
然后按照顺序，依次调用每一个认证后端，知道找到第一个认证成功/失败的后端，
该函数才退出！</p>
<p>至此，整个用户登录的流程，已经完全清晰了。</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id33">13.3. 参考</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><a class="reference external" href="http://djangobook.py3k.cn/2.0/chapter17/">http://djangobook.py3k.cn/2.0/chapter17/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><a class="reference external" href="http://lukejin.iteye.com/blog/599783">http://lukejin.iteye.com/blog/599783</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="http://www.52ij.com/jishu/1174.html">http://www.52ij.com/jishu/1174.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><a class="reference external" href="http://www.cnblogs.com/daoluanxiaozi/p/3320618.html">http://www.cnblogs.com/daoluanxiaozi/p/3320618.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td><a class="reference external" href="http://www.nowamagic.net/academy/detail/13281811">http://www.nowamagic.net/academy/detail/13281811</a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cloud_check.html" class="btn btn-neutral float-right" title="14. 云平台服务器重启注意事项" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="django-generic_view.html" class="btn btn-neutral" title="12. django通用视图：一个小问题引发的思考" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, chenshiqiang.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>